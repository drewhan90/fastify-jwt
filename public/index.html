<!DOCTYPE html>
<html>
<body>
    <h1>Fasity JWT</h1>
    <button id="authenticate">authenticate</button>
    <button id="protected">protected</button>
    <button id="unprotected">unprotected</button>

<script>
    document.getElementById('authenticate').addEventListener('click', singIn)
    document.getElementById('protected').addEventListener('click', protected)
    document.getElementById('unprotected').addEventListener('click', unProtected)

    var token = ""

    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    };

    function customFetch(url, options = {}) {
        return fetch(url, {
            ...options, 
            headers: {
                Authorization: `Bearer ${token}`
            }
        })
    }

    function singIn() {
        fetch('http://localhost:3000/signin', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                console.log(data)
                token = data.token
                console.log(parseJwt(data.token))
            })
            .catch(err => {
                console.log('catch')
                console.log(err)
            })
    }

    function protected() {
        customFetch('http://localhost:3000/protected')
            .then(res => res.json())
            .then(data => {
                console.log(data)
            })
            .catch(err => {
                console.log('catch')
                console.log(err)
            })
    }

    function unProtected() {
        customFetch('http://localhost:3000/unprotected')
            .then(res => res.json())
            .then(data => {
                console.log(data)
            })
            .catch(err => {
                console.log('catch')
                console.log(err)
            })
    }
</script>
</body>
</html>